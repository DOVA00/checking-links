<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–æ–≤, —Å—Å—ã–ª–æ–∫ –∏ —Ñ–∞–π–ª–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --safe-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
            background: white;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
            margin-bottom: -2px;
        }

        .nav-tabs .nav-link:hover {
            color: #495057;
            background-color: #f8f9fa;
        }

        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background-color: white;
            border-bottom: 3px solid #0d6efd;
            font-weight: 600;
        }

        .file-upload-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .file-upload-area:hover {
            border-color: #0d6efd;
            background: #e7f1ff;
        }

        .file-upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .file-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .trust-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .result-item {
            border-left: 4px solid #dee2e6;
            padding-left: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .result-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }

        .result-item.safe { border-left-color: var(--safe-color); }
        .result-item.warning { border-left-color: var(--warning-color); }
        .result-item.danger { border-left-color: var(--danger-color); }

        .loading {
            display: none;
        }

        .progress {
            height: 10px;
            border-radius: 5px;
        }

        .stats-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 15px;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .url-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background: #f8f9fa;
        }

        .url-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .url-item:last-child {
            border-bottom: none;
        }

        .check-success { color: var(--safe-color); }
        .check-warning { color: var(--warning-color); }
        .check-danger { color: var(--danger-color); }

        .file-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        h1 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-10">
            <div class="text-center">
                <h1 class="mb-3">
                    <i class="fas fa-shield-alt text-primary me-2"></i>
                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–æ–≤, —Å—Å—ã–ª–æ–∫ –∏ —Ñ–∞–π–ª–æ–≤
                </h1>
                <p class="subtitle">
                    –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–µ–±-—Å–∞–π—Ç–æ–≤, –∏–∑–≤–ª–µ–∫–∞–π—Ç–µ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤
                </p>
            </div>
        </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs" id="checkTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="single-tab" data-bs-toggle="tab"
                                    data-bs-target="#single" type="button">
                                <i class="fas fa-link me-2"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∞–π—Ç/—Å—Å—ã–ª–∫—É
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="batch-tab" data-bs-toggle="tab"
                                    data-bs-target="#batch" type="button">
                                <i class="fas fa-list me-2"></i> –ù–µ—Å–∫–æ–ª—å–∫–æ —Å—Å—ã–ª–æ–∫
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="file-tab" data-bs-toggle="tab"
                                    data-bs-target="#file" type="button">
                                <i class="fas fa-file-alt me-2"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stats-tab" data-bs-toggle="tab"
                                    data-bs-target="#stats" type="button">
                                <i class="fas fa-chart-bar me-2"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                            </button>
                        </li>
                    </ul>

                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
                    <div class="tab-content mt-4" id="checkTabContent">

                        <!-- –û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ -->
                        <div class="tab-pane fade show active" id="single" role="tabpanel">
                            <h5 class="mb-3"><i class="fas fa-search me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–∏–Ω —Å–∞–π—Ç –∏–ª–∏ —Å—Å—ã–ª–∫—É</h5>
                            <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-globe"></i>
                                    </span>
                                <input type="text" class="form-control"
                                       id="singleUrl"
                                       placeholder="https://example.com –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ example.com">
                                <button class="btn btn-primary" onclick="checkSingle()">
                                    <i class="fas fa-check me-2"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                –ü—Ä–∏–º–µ—Ä—ã: google.com, https://youtube.com, http://example.com
                            </small>

                            <div class="loading mt-3 text-center" id="singleLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                                <p class="mt-2">–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å...</p>
                            </div>

                            <div id="singleResult" class="mt-3"></div>
                        </div>

                        <!-- –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ -->
                        <div class="tab-pane fade" id="batch" role="tabpanel">
                            <h5 class="mb-3"><i class="fas fa-list-check me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Å—ã–ª–æ–∫</h5>
                            <textarea class="form-control mb-3"
                                      id="batchUrls"
                                      rows="5"
                                      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫–∏, –∫–∞–∂–¥—É—é —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏:
https://google.com
youtube.com
example.com"></textarea>

                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-primary" onclick="checkBatch()">
                                    <i class="fas fa-play me-2"></i> –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearBatch()">
                                    <i class="fas fa-trash me-2"></i> –û—á–∏—Å—Ç–∏—Ç—å
                                </button>
                                <button class="btn btn-outline-info" onclick="addExampleLinks()">
                                    <i class="fas fa-magic me-2"></i> –ü—Ä–∏–º–µ—Ä
                                </button>
                            </div>

                            <div class="loading mt-3" id="batchLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                                <p class="mt-2">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫–∏...</p>
                                <div class="progress mt-3">
                                    <div id="batchProgress" class="progress-bar progress-bar-striped progress-bar-animated"
                                         style="width: 0%"></div>
                                </div>
                            </div>

                            <div id="batchResult" class="mt-3"></div>
                        </div>

                        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ -->
                        <div class="tab-pane fade" id="file" role="tabpanel">
                            <h5 class="mb-3"><i class="fas fa-file-upload me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Å—ã–ª–∫–∏ –≤ —Ñ–∞–π–ª–µ</h5>
                            <p class="text-muted mb-3">
                                –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (—Ç–µ–∫—Å—Ç–æ–≤—ã–π, PDF, Word, HTML) –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Å—ã–ª–æ–∫
                            </p>

                            <div class="file-upload-area" id="fileDropArea">
                                <div class="file-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h5>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</h5>
                                <p class="text-muted">–∏–ª–∏</p>
                                <input type="file" id="fileInput" class="d-none" accept=".txt,.pdf,.doc,.docx,.html,.htm">
                                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open me-2"></i> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                                </button>
                                <p class="text-muted mt-2">
                                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: TXT, PDF, DOC, DOCX, HTML<br>
                                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB
                                </p>
                            </div>

                            <div class="file-info d-none" id="fileInfo">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong><i class="fas fa-file me-2"></i><span id="fileName"></span></strong>
                                        <small class="text-muted ms-2" id="fileSize"></small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="loading mt-3 text-center" id="fileLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                                <p class="mt-2">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª...</p>
                                <div class="progress mt-3 w-50 mx-auto">
                                    <div id="fileProgress" class="progress-bar progress-bar-striped progress-bar-animated"
                                         style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="mt-3" id="fileResult"></div>
                        </div>

                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        <div class="tab-pane fade" id="stats" role="tabpanel">
                            <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫</h5>

                            <div class="row mb-4" id="statsCards"></div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="fas fa-history me-2"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</h6>
                                            <div class="url-list" id="recentChecks">
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="fas fa-chart-pie me-2"></i>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º</h6>
                                            <div id="levelDistribution" class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearLocalHistory()">
                                    <i class="fas fa-trash me-2"></i> –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
                                </button>
                                <small class="text-muted d-block mt-2">
                                    –õ–æ–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-body text-center">
                    <h6><i class="fas fa-info-circle me-2"></i>–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∏—Å—Ç–µ–º–∞?</h6>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="p-3">
                                <i class="fas fa-lock fa-2x text-primary mb-2"></i>
                                <h6>HTTPS/SSL</h6>
                                <small class="text-muted">–ó–∞—â–∏—â–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3">
                                <i class="fas fa-calendar-alt fa-2x text-primary mb-2"></i>
                                <h6>–í–æ–∑—Ä–∞—Å—Ç –¥–æ–º–µ–Ω–∞</h6>
                                <small class="text-muted">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3">
                                <i class="fas fa-shield-virus fa-2x text-primary mb-2"></i>
                                <h6>Google Safe Browsing</h6>
                                <small class="text-muted">–ó–∞—â–∏—Ç–∞ –æ—Ç —É–≥—Ä–æ–∑</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3">
                                <i class="fas fa-file-contract fa-2x text-primary mb-2"></i>
                                <h6>–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–ª–∏—Ç–∏–∫–∏</h6>
                                <small class="text-muted">–ù–∞–ª–∏—á–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentFile = null;

    // ===== –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò =====

    function showLoading(id) {
        document.getElementById(id).style.display = 'block';
    }

    function hideLoading(id) {
        document.getElementById(id).style.display = 'none';
    }

    function getTrustClass(score) {
        if (score >= 85) return 'safe';
        if (score >= 70) return 'safe';
        if (score >= 50) return 'warning';
        if (score >= 30) return 'warning';
        return 'danger';
    }

    function getTrustBadgeClass(level) {
        switch(level) {
            case '–û–ß–ï–ù–¨ –í–´–°–û–ö–ò–ô': return 'success';
            case '–í–´–°–û–ö–ò–ô': return 'success';
            case '–°–†–ï–î–ù–ò–ô': return 'warning';
            case '–ù–ò–ó–ö–ò–ô': return 'danger';
            case '–û–ü–ê–°–ù–´–ô': return 'dark';
            default: return 'secondary';
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ===== –û–î–ò–ù–û–ß–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê =====

    async function checkSingle() {
        const url = document.getElementById('singleUrl').value.trim();
        if (!url) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
            return;
        }

        showLoading('singleLoading');
        document.getElementById('singleResult').innerHTML = '';

        try {
            const response = await fetch(`/api/check?link=${encodeURIComponent(url)}`);
            const data = await response.json();

            if (response.ok) {
                displaySingleResult(data);
                saveToLocalHistory(data);
            } else {
                showError('singleResult', data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ');
            }
        } catch (error) {
            showError('singleResult', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        } finally {
            hideLoading('singleLoading');
        }
    }

    function displaySingleResult(data) {
        const container = document.getElementById('singleResult');
        const trustClass = getTrustClass(data.score);

        container.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center border-end">
                            <div class="display-4 ${trustClass} fw-bold">${Math.round(data.score)}%</div>
                            <span class="badge bg-${getTrustBadgeClass(data.level)} mt-2">
                                ${data.level}
                            </span>
                            <p class="text-muted mt-3">${data.link}</p>
                        </div>
                        <div class="col-md-9">
                            <h6>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:</h6>
                            <div class="row mt-3">
                                ${renderCheckItems(data)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderCheckItems(data) {
        const checks = [
            { name: 'HTTPS', value: data.https, icon: 'lock' },
            { name: 'SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç', value: data.validSSL, icon: 'certificate' },
            { name: '–ë–µ–∑–æ–ø–∞—Å–µ–Ω –ø–æ Google', value: data.safeBrowsing, icon: 'shield-alt' },
            { name: '–í–∞–ª–∏–¥–Ω—ã–π –¥–æ–º–µ–Ω', value: data.validDomain, icon: 'check-circle' },
            { name: '–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤', value: data.hasContact, icon: 'address-book' },
            { name: '–ü–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏', value: data.hasPrivacyPolicy, icon: 'file-contract' }
        ];

        return checks.map(check => `
            <div class="col-md-4 mb-2">
                <div class="d-flex align-items-center ${check.value ? 'check-success' : 'check-danger'}">
                    <i class="fas fa-${check.icon} me-2"></i>
                    <span class="me-2">${check.name}:</span>
                    <span class="badge bg-${check.value ? 'success' : 'danger'}">
                        ${check.value ? '‚úì' : '‚úó'}
                    </span>
                </div>
            </div>
        `).join('');
    }

    // ===== –ú–ê–°–°–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê =====

    function addExampleLinks() {
        const examples = [
            'https://google.com',
            'youtube.com',
            'https://github.com',
            'example.com',
            'https://stackoverflow.com'
        ];
        document.getElementById('batchUrls').value = examples.join('\n');
    }

    async function checkBatch() {
        const textarea = document.getElementById('batchUrls');
        const urls = textarea.value.trim().split('\n')
            .map(url => url.trim())
            .filter(url => url.length > 0);

        if (urls.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Å—ã–ª–∫—É');
            return;
        }

        if (urls.length > 20) {
            alert('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ - 20');
            return;
        }

        showLoading('batchLoading');
        document.getElementById('batchResult').innerHTML = '';
        const progressBar = document.getElementById('batchProgress');
        progressBar.style.width = '0%';

        const results = [];

        for (let i = 0; i < urls.length; i++) {
            try {
                const response = await fetch(`/api/check?link=${encodeURIComponent(urls[i])}`);
                if (response.ok) {
                    const data = await response.json();
                    results.push({ url: urls[i], success: true, data });
                    saveToLocalHistory(data);
                } else {
                    results.push({ url: urls[i], success: false, error: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏' });
                }
            } catch (error) {
                results.push({ url: urls[i], success: false, error: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' });
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progress = ((i + 1) / urls.length) * 100;
            progressBar.style.width = progress + '%';
            progressBar.textContent = `${i + 1}/${urls.length}`;
        }

        displayBatchResults(results);
        hideLoading('batchLoading');
    }

    function displayBatchResults(results) {
        const container = document.getElementById('batchResult');

        let html = `<h6>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (${results.length}):</h6>`;

        results.forEach(result => {
            if (result.success) {
                const trustClass = getTrustClass(result.data.score);
                html += `
                    <div class="result-item ${trustClass}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-truncate" style="max-width: 60%;">
                                <i class="fas fa-link text-muted me-2"></i>
                                ${result.url}
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${getTrustBadgeClass(result.data.level)} me-2">
                                    ${result.data.level}
                                </span>
                                <span class="fw-bold ${trustClass}">
                                    ${Math.round(result.data.score)}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="result-item danger">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-truncate" style="max-width: 70%;">
                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                ${result.url}
                            </div>
                            <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                        </div>
                    </div>
                `;
            }
        });

        container.innerHTML = html;
    }

    function clearBatch() {
        document.getElementById('batchUrls').value = '';
        document.getElementById('batchResult').innerHTML = '';
    }

    // ===== –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í =====

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('fileInput');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('dragover');
        }

        function unhighlight() {
            dropArea.classList.remove('dragover');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ drop
        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            const allowedTypes = [
                'text/plain',
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/html'
            ];

            if (!allowedTypes.includes(file.type) &&
                !file.name.match(/\.(txt|pdf|doc|docx|html|htm)$/i)) {
                alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞!');
                return;
            }

            currentFile = file;
            showFileInfo(file);
        }
    });

    function showFileInfo(file) {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = `(${formatBytes(file.size)})`;
        document.getElementById('fileInfo').classList.remove('d-none');
    }

    function clearFile() {
        currentFile = null;
        document.getElementById('fileInput').value = '';
        document.getElementById('fileInfo').classList.add('d-none');
        document.getElementById('fileResult').innerHTML = '';
    }

    async function checkFile() {
        if (!currentFile) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
            return;
        }

        showLoading('fileLoading');
        document.getElementById('fileResult').innerHTML = '';
        const progressBar = document.getElementById('fileProgress');
        progressBar.style.width = '0%';

        const formData = new FormData();
        formData.append('file', currentFile);

        try {
            const response = await fetch('/api/advanced/check-file', {
                method: 'POST',
                body: formData
            });

            progressBar.style.width = '50%';

            const data = await response.json();
            progressBar.style.width = '100%';

            if (response.ok) {
                displayFileResults(data);
            } else {
                showError('fileResult', data.error || '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞');
            }
        } catch (error) {
            showError('fileResult', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
        } finally {
            setTimeout(() => hideLoading('fileLoading'), 500);
        }
    }

    function displayFileResults(data) {
        const container = document.getElementById('fileResult');

        let html = `
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-file-alt me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–∞</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <i class="fas fa-hashtag me-2"></i>
                                <strong>${data.totalUrlsFound || 0}</strong> —Å—Å—ã–ª–æ–∫ –Ω–∞–π–¥–µ–Ω–æ
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>${data.checkedUrls || 0}</strong> –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-secondary">
                                <i class="fas fa-file me-2"></i>
                                ${data.fileName || '–§–∞–π–ª'}
                            </div>
                        </div>
                    </div>
        `;

        if (data.results && data.results.length > 0) {
            html += `<h6>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏:</h6><div class="url-list">`;

            data.results.forEach(item => {
                if (item.result) {
                    const result = item.result;
                    const trustClass = getTrustClass(result.score);
                    html += `
                        <div class="url-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-truncate" style="max-width: 60%;">
                                    <i class="fas fa-link text-muted me-2"></i>
                                    ${item.url}
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${getTrustBadgeClass(result.level)} me-2">
                                        ${result.level}
                                    </span>
                                    <span class="fw-bold ${trustClass}">
                                        ${Math.round(result.score)}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            html += `</div>`;
        } else {
            html += `<div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            </div>`;
        }

        html += `</div></div>`;
        container.innerHTML = html;
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
    document.getElementById('fileInput').addEventListener('change', function() {
        if (this.files.length > 0) {
            setTimeout(checkFile, 100);
        }
    });

    // ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê =====

    async function loadStats() {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const response = await fetch('/api/stats');
            const serverStats = await response.json();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
            const localHistory = loadLocalHistory();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            updateStatsCards(serverStats, localHistory);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
            updateRecentChecks(localHistory);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            updateLevelDistribution(localHistory);

        } catch (error) {
            document.getElementById('statsCards').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                </div>
            `;
        }
    }

    function updateStatsCards(serverStats, localHistory) {
        const container = document.getElementById('statsCards');

        const totalLocal = localHistory.length;
        const avgLocal = localHistory.length > 0
            ? Math.round(localHistory.reduce((sum, item) => sum + item.score, 0) / localHistory.length)
            : 0;

        container.innerHTML = `
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-globe fa-2x"></i>
                    <div class="stats-number">${serverStats.totalCheckedAllTime || 0}</div>
                    <p>–í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫<br>(—Å–µ—Ä–≤–µ—Ä)</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-history fa-2x"></i>
                    <div class="stats-number">${totalLocal}</div>
                    <p>–í–∞—à–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏<br>(–ª–æ–∫–∞–ª—å–Ω–æ)</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-chart-line fa-2x"></i>
                    <div class="stats-number">${serverStats.averageScoreAllTime || 0}%</div>
                    <p>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª<br>(—Å–µ—Ä–≤–µ—Ä)</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <i class="fas fa-star fa-2x"></i>
                    <div class="stats-number">${avgLocal}%</div>
                    <p>–í–∞—à —Å—Ä–µ–¥–Ω–∏–π<br>–±–∞–ª–ª</p>
                </div>
            </div>
        `;
    }

    function updateRecentChecks(history) {
        const container = document.getElementById('recentChecks');

        if (history.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="far fa-folder-open fa-2x mb-2"></i>
                    <p>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø—É—Å—Ç–∞</p>
                </div>
            `;
            return;
        }

        let html = '';
        const recent = history.slice(0, 10);

        recent.forEach(item => {
            const trustClass = getTrustClass(item.score);
            html += `
                <div class="url-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-truncate" style="max-width: 55%;">
                            <small><i class="fas fa-link text-muted me-1"></i></small>
                            ${item.link}
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${getTrustBadgeClass(item.level)} me-1">
                                ${item.level}
                            </span>
                            <span class="${trustClass} fw-bold">
                                ${Math.round(item.score)}%
                            </span>
                            <br>
                            <small class="text-muted">
                                ${new Date(item.timestamp).toLocaleDateString('ru-RU')}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function updateLevelDistribution(history) {
        const container = document.getElementById('levelDistribution');

        if (history.length === 0) {
            container.innerHTML = '<p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            return;
        }

        const distribution = {};
        history.forEach(item => {
            distribution[item.level] = (distribution[item.level] || 0) + 1;
        });

        const colors = {
            '–û–ß–ï–ù–¨ –í–´–°–û–ö–ò–ô': '#28a745',
            '–í–´–°–û–ö–ò–ô': '#17a2b8',
            '–°–†–ï–î–ù–ò–ô': '#ffc107',
            '–ù–ò–ó–ö–ò–ô': '#fd7e14',
            '–û–ü–ê–°–ù–´–ô': '#dc3545'
        };

        let html = '<div class="row justify-content-center">';
        for (const [level, count] of Object.entries(distribution)) {
            const percentage = Math.round((count / history.length) * 100);
            html += `
                <div class="col-auto text-center mb-2">
                    <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 60px; height: 60px; background: ${colors[level] || '#6c757d'}; color: white;">
                        ${percentage}%
                    </div>
                    <div class="small">
                        <strong>${level}</strong><br>
                        <span class="text-muted">${count} —à—Ç.</span>
                    </div>
                </div>
            `;
        }
        html += '</div>';

        container.innerHTML = html;
    }

    // ===== –õ–û–ö–ê–õ–¨–ù–ê–Ø –ò–°–¢–û–†–ò–Ø =====

    function saveToLocalHistory(result) {
        let history = JSON.parse(localStorage.getItem('checkHistory') || '[]');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Å—Å—ã–ª–∫–∏
        const existingIndex = history.findIndex(item => item.link === result.link);
        if (existingIndex !== -1) {
            history.splice(existingIndex, 1); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å
        }

        history.unshift({
            ...result,
            checkedAt: new Date().toISOString()
        });

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 100 –∑–∞–ø–∏—Å—è–º–∏
        if (history.length > 100) {
            history = history.slice(0, 100);
        }

        localStorage.setItem('checkHistory', JSON.stringify(history));
        return history;
    }

    function loadLocalHistory() {
        return JSON.parse(localStorage.getItem('checkHistory') || '[]');
    }

    function clearLocalHistory() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫?')) {
            localStorage.removeItem('checkHistory');
            loadStats(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        }
    }

    // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====

    function showError(containerId, message) {
        document.getElementById(containerId).innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
    document.getElementById('stats-tab').addEventListener('click', loadStats);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    document.getElementById('singleUrl').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') checkSingle();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –≤–∫–ª–∞–¥–∫–∞
        if (document.getElementById('stats').classList.contains('active')) {
            loadStats();
        }
    });
</script>
</body>
</html>